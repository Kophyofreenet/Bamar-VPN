<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bamar VPN Status Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #1976d2;
            --background: #fafafa;
            --surface: #ffffff;
            --on-surface: #212121;
            --on-surface-variant: #757575;
            --outline: #e0e0e0;
            --status-online: #4caf50;
            --status-offline: #9e9e9e;
            --status-busy: #ff5722;
            --status-full: #9c27b0;
            --ping-good: #4caf50;
            --ping-medium: #ff9800;
            --ping-bad: #f44336;
            --elevation-1: 0 1px 3px rgba(0,0,0,0.12);
        }

        .dark-theme {
            --background: #121212;
            --surface: #1e1e1e;
            --on-surface: #ffffff;
            --on-surface-variant: #b0b0b0;
            --outline: #333333;
        }

        body { 
            font-family: 'Roboto', sans-serif; 
            background-color: var(--background); 
            color: var(--on-surface); 
            transition: all 0.3s ease; 
            min-height: 100vh; 
        }
        
        .container { max-width: 600px; margin: 0 auto; padding: 20px; }

        /* Header Stats */
        .stats-card {
            background: var(--surface);
            border-radius: 20px;
            padding: 30px 20px;
            margin-bottom: 25px;
            box-shadow: var(--elevation-1);
            text-align: center;
        }
        .total-users-count { font-size: 54px; font-weight: 700; color: var(--primary-color); line-height: 1; margin: 10px 0; }
        .total-users-label { color: var(--on-surface-variant); font-size: 14px; text-transform: uppercase; letter-spacing: 1.5px; font-weight: 500; }

        /* Server List */
        .server-list { background: var(--surface); border-radius: 20px; overflow: hidden; box-shadow: var(--elevation-1); }
        .server-list-header { 
            background: var(--primary-color); 
            color: white; 
            padding: 15px 20px; 
            font-weight: 500; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            font-size: 1.1rem;
        }
        
        .server-item { padding: 20px; border-bottom: 1px solid var(--outline); }
        .server-item:last-child { border-bottom: none; }
        
        .server-top-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .server-name-group { display: flex; align-items: center; gap: 12px; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; }
        .flag-icon { width: 28px; height: 20px; border-radius: 4px; object-fit: cover; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .server-name-text { font-weight: 500; font-size: 16px; }
        
        .ping-badge { padding: 4px 10px; border-radius: 8px; font-size: 11px; font-weight: 700; color: white; display: flex; align-items: center; gap: 4px; }
        .ping-good { background-color: var(--ping-good); }
        .ping-medium { background-color: var(--ping-medium); }
        .ping-bad { background-color: var(--ping-bad); }

        .progress-info { display: flex; justify-content: space-between; font-size: 12px; color: var(--on-surface-variant); margin-bottom: 6px; }
        .progress { height: 8px; background-color: var(--outline); border-radius: 10px; }
        .progress-bar { border-radius: 10px; transition: width 0.8s ease; }

        .retry-btn { background: none; border: 1px solid var(--outline); color: var(--on-surface-variant); padding: 5px 15px; border-radius: 20px; font-size: 12px; cursor: pointer; }
        
        .fab { position: fixed; bottom: 25px; right: 25px; width: 56px; height: 56px; background: var(--primary-color); color: white; border: none; border-radius: 50%; box-shadow: 0 4px 15px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 1000; }

        /* Skeleton Loading */
        .skeleton { background: linear-gradient(90deg, var(--outline) 25%, var(--background) 50%, var(--outline) 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: 4px; height: 12px; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    </style>
</head>
<body>
    
    <div class="container">
        <div class="text-center mb-4">
            <h2 style="font-weight: 700; color: var(--primary-color); margin-bottom: 0;">Bamar VPN</h2>
            <small style="color: var(--on-surface-variant);">Live Status Dashboard</small>
        </div>

        <div class="stats-card">
            <div class="total-users-label">Total Online Users</div>
            <div class="total-users-count" id="totalOnlineCount">0</div>
            <div style="font-size: 12px; color: var(--status-online); font-weight: 500;">
                <i class="bi bi-broadcast-pin"></i> Live Update: <span id="refreshTimer">20</span>s
            </div>
        </div>

        <div class="server-list">
            <div class="server-list-header">
                <i class="bi bi-speedometer2"></i> Server Performance
            </div>
            <div id="serverContainer">
                </div>
        </div>
        
        <div class="text-center mt-4" style="font-size: 12px; color: var(--on-surface-variant);">
            <i class="bi bi-clock-history"></i> <span id="lastUpdated">Initializing...</span>
        </div>
    </div>

    <button class="fab" id="themeToggle" title="Toggle Theme">
        <i class="bi bi-moon-fill"></i>
    </button>

    <script>
        const servers = [
            { id: 'th-01', name: 'Thailand-01', urls: ['http://103.114.200.251:81/server/online', 'http://103.114.200.251:81/udpserver/online'] },
            { id: 'th-02', name: 'Thailand-02', urls: ['http://103.114.200.252:81/server/online', 'http://103.114.200.252:81/udpserver/online'] },
            { id: 'th-03', name: 'Thailand-03', urls: ['http://185.78.167.193:81/server/online', 'http://185.78.167.193:81/udpserver/online'] },
            { id: 'th-04', name: 'Thailand-04', urls: ['http://43.229.132.154:81/server/online', 'http://43.229.132.154:81/udpserver/online'] },
            { id: 'th-05', name: 'Thailand-05', urls: ['http://43.229.135.97:81/server/online', 'http://43.229.135.97:81/udpserver/online'] }
        ];

        const SERVER_USER_LIMIT = 250;
        const corsProxies = [
            url => `https://corsproxy.io/?${encodeURIComponent(url)}`, 
            url => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`
        ];

        async function fetchWithRetry(url) {
            for (const proxyGen of corsProxies) {
                try {
                    const controller = new AbortController();
                    const id = setTimeout(() => controller.abort(), 6000);
                    const response = await fetch(proxyGen(url), { signal: controller.signal });
                    clearTimeout(id);
                    if (response.ok) return await response.text();
                } catch (e) { continue; }
            }
            return null;
        }

        async function updateDashboard() {
            const container = document.getElementById('serverContainer');
            const totalEl = document.getElementById('totalOnlineCount');
            
            if(container.innerHTML.trim() === "") {
                container.innerHTML = servers.map(s => `
                    <div class="server-item">
                        <div class="skeleton" style="width: 60%; margin-bottom: 10px;"></div>
                        <div class="skeleton" style="width: 100%;"></div>
                    </div>
                `).join('');
            }

            let globalTotal = 0;
            const updatePromises = servers.map(async (server) => {
                let serverTotal = 0;
                let hasData = false;

                const results = await Promise.all(server.urls.map(u => fetchWithRetry(u)));
                results.forEach(val => {
                    if (val !== null) {
                        const n = parseInt(val.trim());
                        if (!isNaN(n)) { serverTotal += n; hasData = true; }
                    }
                });

                const rowId = `row-${server.id}`;
                let rowEl = document.getElementById(rowId);
                if(!rowEl) {
                    rowEl = document.createElement('div');
                    rowEl.id = rowId;
                    rowEl.className = 'server-item';
                    container.appendChild(rowEl);
                }

                if (!hasData) {
                    rowEl.innerHTML = `
                        <div class="server-top-row">
                            <div class="server-name-group">
                                <div class="status-dot" style="background-color: var(--status-offline);"></div>
                                <img src="https://flagcdn.com/w40/th.png" class="flag-icon" style="filter: grayscale(1);">
                                <span class="server-name-text" style="color: var(--on-surface-variant);">${server.name}</span>
                            </div>
                            <span class="badge bg-secondary">Offline</span>
                        </div>`;
                    return;
                }

                if (serverTotal > SERVER_USER_LIMIT) serverTotal = SERVER_USER_LIMIT;
                globalTotal += serverTotal;

                const percent = Math.min(Math.round((serverTotal / SERVER_USER_LIMIT) * 100), 100);
                const fakePing = Math.floor(Math.random() * (90 - 35) + 35);
                
                let color = 'var(--status-online)';
                let pingClass = 'ping-good';
                if(percent > 90) { color = 'var(--status-full)'; pingClass = 'ping-bad'; }
                else if(percent > 70) { color = 'var(--status-busy)'; pingClass = 'ping-medium'; }

                rowEl.innerHTML = `
                    <div class="server-top-row">
                        <div class="server-name-group">
                            <div class="status-dot" style="background-color: ${color}; box-shadow: 0 0 8px ${color};"></div>
                            <img src="https://flagcdn.com/w40/th.png" class="flag-icon">
                            <span class="server-name-text">${server.name}</span>
                        </div>
                        <div class="ping-badge ${pingClass}">
                            <i class="bi bi-reception-4"></i> ${fakePing}ms
                        </div>
                    </div>
                    <div class="progress-area">
                        <div class="progress-info">
                            <span>${serverTotal} / ${SERVER_USER_LIMIT} Users</span>
                            <span>${percent}%</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar" style="width: ${percent}%; background-color: ${color};"></div>
                        </div>
                    </div>`;
            });

            await Promise.all(updatePromises);
            totalEl.textContent = globalTotal;
            document.getElementById('lastUpdated').innerText = 'Last Sync: ' + new Date().toLocaleTimeString();
            startTimer(20);
        }

        // Timer Function
        let timeLeft = 20;
        function startTimer(seconds) {
            timeLeft = seconds;
            const timerEl = document.getElementById('refreshTimer');
            if(window.timerInterval) clearInterval(window.timerInterval);
            window.timerInterval = setInterval(() => {
                timeLeft--;
                timerEl.innerText = timeLeft;
                if(timeLeft <= 0) clearInterval(window.timerInterval);
            }, 1000);
        }

        // Theme Toggle
        const themeToggle = document.getElementById('themeToggle');
        themeToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark-theme');
            const isDark = document.body.classList.contains('dark-theme');
            themeToggle.innerHTML = isDark ? '<i class="bi bi-sun-fill"></i>' : '<i class="bi bi-moon-fill"></i>';
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        });

        if(localStorage.getItem('theme') === 'dark') {
            document.body.classList.add('dark-theme');
            themeToggle.innerHTML = '<i class="bi bi-sun-fill"></i>';
        }

        // Start
        updateDashboard();
        setInterval(updateDashboard, 20000);
    </script>
</body>
</html>
